name: Upload to Wenshushu

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      file_url:
        description: 'è¦ä¸Šä¼ çš„æ–‡ä»¶URL'
        required: true
        type: string
      file_name:
        description: 'ä¿å­˜çš„æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      expiration:
        description: 'æ–‡ä»¶æœ‰æ•ˆæœŸï¼ˆå¤©ï¼Œé»˜è®¤7å¤©ï¼‰'
        required: false
        type: number
        default: 7
  # ä¹Ÿå¯ä»¥é…ç½®ä¸ºè‡ªåŠ¨è§¦å‘ï¼Œä¾‹å¦‚ï¼š
  # push:
  #   branches: [ main ]
  # schedule:
  #   - cron: '0 0 * * *'  # æ¯å¤©UTC 0ç‚¹è¿è¡Œ

jobs:
  upload-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Download and upload to Wenshushu
      id: upload
      env:
        WENSHUSHU_TOKEN: ${{ secrets.WENSHUSHU_TOKEN }}
        FILE_URL: ${{ github.event.inputs.file_url }}
        FILE_NAME: ${{ github.event.inputs.file_name }}
        EXPIRATION_DAYS: ${{ github.event.inputs.expiration }}
      run: |
        echo "Downloading file from: $FILE_URL"
        
        # Pythonè„šæœ¬ä¸‹è½½å¹¶ä¸Šä¼ 
        python -c "
import requests
import os
import sys
import time
import mimetypes

# ä»ç¯å¢ƒå˜é‡è·å–å‚æ•°
file_url = os.getenv('FILE_URL')
file_name = os.getenv('FILE_NAME')
expiration_days = int(os.getenv('EXPIRATION_DAYS', 7))
token = os.getenv('WENSHUSHU_TOKEN')

if not token:
    print('âŒ é”™è¯¯ï¼šè¯·è®¾ç½®WENSHUSHU_TOKEN secret')
    sys.exit(1)

if not file_url:
    print('âŒ é”™è¯¯ï¼šè¯·æä¾›æ–‡ä»¶URL')
    sys.exit(1)

# ä¸‹è½½æ–‡ä»¶
try:
    print(f'ğŸ“¥ æ­£åœ¨ä¸‹è½½: {file_url}')
    response = requests.get(file_url, stream=True, timeout=30)
    response.raise_for_status()
    
    # å¦‚æœæ²¡æœ‰æä¾›æ–‡ä»¶åï¼Œä»URLæˆ–å“åº”å¤´ä¸­æå–
    if not file_name:
        # å°è¯•ä»Content-Dispositionå¤´è·å–æ–‡ä»¶å
        content_disposition = response.headers.get('Content-Disposition', '')
        if 'filename=' in content_disposition:
            import re
            filename_match = re.search(r'filename=[\"\']?([^\"\'\s]+)[\"\']?', content_disposition)
            if filename_match:
                file_name = filename_match.group(1)
        # ä»URLæå–
        if not file_name:
            file_name = file_url.split('/')[-1].split('?')[0]
            if not file_name or '.' not in file_name:
                file_name = f'downloaded_file_{int(time.time())}.bin'
    
    # ä¿å­˜ä¸´æ—¶æ–‡ä»¶
    temp_file = f'/tmp/{file_name}'
    with open(temp_file, 'wb') as f:
        for chunk in response.iter_content(chunk_size=8192):
            if chunk:
                f.write(chunk)
    
    file_size = os.path.getsize(temp_file)
    print(f'âœ… ä¸‹è½½å®Œæˆ: {file_name} ({file_size} bytes)')
    
    # ä¸Šä¼ åˆ°æ–‡å”å”
    print('ğŸš€ æ­£åœ¨ä¸Šä¼ åˆ°æ–‡å”å”...')
    
    # æ­¥éª¤1: è·å–ä¸Šä¼ é“¾æ¥å’Œtoken
    init_url = 'https://www.wenshushu.cn/ap/upload/init'
    headers = {
        'Accept': 'application/json, text/plain, */*',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Referer': 'https://www.wenshushu.cn/',
        'x-token': token
    }
    
    # è·å–æ–‡ä»¶MIMEç±»å‹
    mime_type, _ = mimetypes.guess_type(file_name)
    if not mime_type:
        mime_type = 'application/octet-stream'
    
    init_data = {
        'name': file_name,
        'size': file_size,
        'type': mime_type,
        'expire': expiration_days * 86400,  # è½¬æ¢ä¸ºç§’
        'pwd': '',
        'up_type': 'file'
    }
    
    init_response = requests.post(init_url, headers=headers, json=init_data)
    init_result = init_response.json()
    
    if init_result.get('code') != 0:
        print(f'âŒ åˆå§‹åŒ–å¤±è´¥: {init_result}')
        sys.exit(1)
    
    upload_data = init_result['data']
    upload_url = upload_data['url']
    upload_key = upload_data['key']
    fsize = upload_data['fsize']
    
    # æ­¥éª¤2: ä¸Šä¼ æ–‡ä»¶
    print(f'ğŸ“¤ ä¸Šä¼ åˆ°: {upload_url}')
    
    with open(temp_file, 'rb') as f:
        upload_response = requests.put(
            upload_url,
            data=f,
            headers={
                'Content-Type': mime_type,
                'Content-Length': str(file_size)
            }
        )
    
    if upload_response.status_code not in [200, 201, 204]:
        print(f'âŒ ä¸Šä¼ å¤±è´¥: {upload_response.status_code}')
        print(upload_response.text)
        sys.exit(1)
    
    # æ­¥éª¤3: å®Œæˆä¸Šä¼ 
    complete_url = 'https://www.wenshushu.cn/ap/upload/complete'
    complete_data = {
        'key': upload_key,
        'fname': file_name,
        'fsize': fsize
    }
    
    complete_response = requests.post(complete_url, headers=headers, json=complete_data)
    complete_result = complete_response.json()
    
    if complete_result.get('code') != 0:
        print(f'âŒ å®Œæˆä¸Šä¼ å¤±è´¥: {complete_result}')
        sys.exit(1)
    
    # è·å–ä¸‹è½½é“¾æ¥
    file_data = complete_result['data']['file']
    file_code = file_data['code']
    download_url = f'https://www.wenshushu.cn/f/{file_code}'
    
    print(f'âœ… ä¸Šä¼ æˆåŠŸï¼')
    print(f'ğŸ“ æ–‡ä»¶åç§°: {file_name}')
    print(f'ğŸ”— ä¸‹è½½é“¾æ¥: {download_url}')
    print(f'ğŸ“… æœ‰æ•ˆæœŸ: {expiration_days}å¤©')
    
    # è¾“å‡ºåˆ°GitHub Actions
    print('::set-output name=download_url::' + download_url)
    print('::set-output name=file_code::' + file_code)
    print('::set-output name=file_name::' + file_name)
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    os.remove(temp_file)
    
except Exception as e:
    print(f'âŒ é”™è¯¯: {str(e)}')
    sys.exit(1)
"
    
    - name: Upload summary
      run: |
        echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
        echo "ä¸‹è½½é“¾æ¥: ${{ steps.upload.outputs.download_url }}"
        echo "æ–‡ä»¶ä»£ç : ${{ steps.upload.outputs.file_code }}"
        echo "æ–‡ä»¶åç§°: ${{ steps.upload.outputs.file_name }}"
    
    - name: Create issue with upload result (å¯é€‰)
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          const { repo, owner } = context.repo;
          const downloadUrl = '${{ steps.upload.outputs.download_url }}';
          const fileName = '${{ steps.upload.outputs.file_name }}';
          
          github.rest.issues.create({
            owner: owner,
            repo: repo,
            title: `ğŸ“¤ æ–‡ä»¶ä¸Šä¼ å®Œæˆ: ${fileName}`,
            body: `æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ åˆ°æ–‡å”å”\n\n` +
                  `**æ–‡ä»¶åç§°:** ${fileName}\n` +
                  `**ä¸‹è½½é“¾æ¥:** ${downloadUrl}\n` +
                  `**ä¸Šä¼ æ—¶é—´:** ${new Date().toISOString()}\n\n` +
                  `æ­¤æ–‡ä»¶æœ‰æ•ˆæœŸä¸º ${{ github.event.inputs.expiration || 7 }} å¤©`
          });
