name: Upload File to Wenshushu

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'æ–‡ä»¶URLåœ°å€'
        required: true
        type: string
      custom_name:
        description: 'è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰'
        required: false
        type: string
      days:
        description: 'æœ‰æ•ˆæœŸï¼ˆå¤©ï¼Œé»˜è®¤7ï¼‰'
        required: false
        type: number
        default: 7

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Create upload script
      run: |
        cat > upload_script.py << 'EOF'
#!/usr/bin/env python3
"""
æ–‡å”å”æ–‡ä»¶ä¸Šä¼ è„šæœ¬
éœ€è¦è®¾ç½® WENSHUSHU_COOKIE ç¯å¢ƒå˜é‡
"""

import requests
import os
import sys
import time
import json
from urllib.parse import urlparse

class WenshushuUploader:
    def __init__(self, cookie):
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Origin': 'https://www.wenshushu.cn',
            'Referer': 'https://www.wenshushu.cn/',
            'Cookie': cookie
        })
        self.base_url = 'https://www.wenshushu.cn/ap'
        
    def check_login(self):
        """æ£€æŸ¥ç™»å½•çŠ¶æ€"""
        try:
            url = f"{self.base_url}/user/info"
            response = self.session.get(url, timeout=10)
            data = response.json()
            if data.get('code') == 0:
                print(f"âœ… ç™»å½•æˆåŠŸï¼Œç”¨æˆ·å: {data.get('data', {}).get('nickname', 'æœªçŸ¥')}")
                return True
            else:
                print(f"âŒ ç™»å½•å¤±è´¥: {data.get('msg')}")
                return False
        except Exception as e:
            print(f"âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: {e}")
            return False
    
    def download_file(self, file_url, save_path):
        """ä¸‹è½½æ–‡ä»¶"""
        try:
            print(f"ğŸ“¥ å¼€å§‹ä¸‹è½½: {file_url}")
            response = requests.get(file_url, stream=True, timeout=30)
            response.raise_for_status()
            
            # è·å–æ–‡ä»¶å
            content_disposition = response.headers.get('content-disposition', '')
            if 'filename=' in content_disposition:
                filename = content_disposition.split('filename=')[1].strip('"\'')
            else:
                filename = os.path.basename(urlparse(file_url).path) or f'file_{int(time.time())}.bin'
            
            total_size = int(response.headers.get('content-length', 0))
            
            with open(save_path, 'wb') as f:
                downloaded = 0
                for chunk in response.iter_content(chunk_size=8192):
                    if chunk:
                        f.write(chunk)
                        downloaded += len(chunk)
                        if total_size > 0:
                            percent = (downloaded / total_size) * 100
                            sys.stdout.write(f"\rä¸‹è½½è¿›åº¦: {percent:.1f}% ({downloaded}/{total_size} bytes)")
                            sys.stdout.flush()
            
            print(f"\nâœ… ä¸‹è½½å®Œæˆ: {save_path}")
            file_size = os.path.getsize(save_path)
            print(f"ğŸ“Š æ–‡ä»¶å¤§å°: {self.format_size(file_size)}")
            return filename, file_size
            
        except Exception as e:
            print(f"âŒ ä¸‹è½½å¤±è´¥: {e}")
            return None, 0
    
    def upload_file(self, file_path, filename, expire_days=7):
        """ä¸Šä¼ æ–‡ä»¶åˆ°æ–‡å”å”"""
        try:
            print(f"ğŸš€ å¼€å§‹ä¸Šä¼ æ–‡ä»¶: {filename}")
            
            # æ­¥éª¤1: è·å–ä¸Šä¼ å‚æ•°
            init_url = f"{self.base_url}/upload/init"
            init_data = {
                "name": filename,
                "size": os.path.getsize(file_path),
                "expire": expire_days * 86400,
                "pwd": "",
                "up_type": "file"
            }
            
            print("ğŸ”§ åˆå§‹åŒ–ä¸Šä¼ ...")
            response = self.session.post(init_url, json=init_data)
            data = response.json()
            
            if data.get('code') != 0:
                print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {data}")
                return None
            
            upload_info = data['data']
            upload_url = upload_info['url']
            upload_key = upload_info['key']
            
            # æ­¥éª¤2: ä¸Šä¼ æ–‡ä»¶åˆ°å­˜å‚¨æœåŠ¡
            print("ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ä¸­...")
            with open(file_path, 'rb') as f:
                upload_response = requests.put(
                    upload_url,
                    data=f,
                    headers={
                        'Content-Type': 'application/octet-stream',
                        'Content-Length': str(os.path.getsize(file_path))
                    }
                )
            
            if upload_response.status_code not in [200, 201, 204]:
                print(f"âŒ ä¸Šä¼ æ–‡ä»¶å¤±è´¥: {upload_response.status_code}")
                return None
            
            # æ­¥éª¤3: å®Œæˆä¸Šä¼ 
            print("ğŸ”¨ å®Œæˆä¸Šä¼ æµç¨‹...")
            complete_url = f"{self.base_url}/upload/complete"
            complete_data = {
                "key": upload_key,
                "fname": filename,
                "fsize": upload_info['fsize']
            }
            
            complete_response = self.session.post(complete_url, json=complete_data)
            complete_data = complete_response.json()
            
            if complete_data.get('code') != 0:
                print(f"âŒ å®Œæˆä¸Šä¼ å¤±è´¥: {complete_data}")
                return None
            
            # è·å–åˆ†äº«é“¾æ¥
            file_info = complete_data['data']['file']
            file_code = file_info['code']
            download_url = f"https://www.wenshushu.cn/f/{file_code}"
            
            print(f"âœ… ä¸Šä¼ æˆåŠŸ!")
            print(f"ğŸ“ æ–‡ä»¶åç§°: {filename}")
            print(f"ğŸ”— ä¸‹è½½é“¾æ¥: {download_url}")
            print(f"ğŸ”‘ æå–ç : {file_info.get('tk', 'æ— ')}")
            print(f"ğŸ“… æœ‰æ•ˆæœŸ: {expire_days}å¤©")
            
            return {
                'download_url': download_url,
                'file_code': file_code,
                'file_name': filename,
                'expire_days': expire_days
            }
            
        except Exception as e:
            print(f"âŒ ä¸Šä¼ è¿‡ç¨‹å¤±è´¥: {e}")
            return None
    
    def format_size(self, size_bytes):
        """æ ¼å¼åŒ–æ–‡ä»¶å¤§å°"""
        for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
            if size_bytes < 1024.0:
                return f"{size_bytes:.2f} {unit}"
            size_bytes /= 1024.0
        return f"{size_bytes:.2f} PB"

def main():
    # è·å–ç¯å¢ƒå˜é‡
    file_url = os.getenv('INPUT_FILE_URL')
    cookie = os.getenv('WENSHUSHU_COOKIE')
    custom_name = os.getenv('INPUT_CUSTOM_NAME')
    days = int(os.getenv('INPUT_DAYS', '7'))
    
    if not file_url:
        print("âŒ é”™è¯¯: è¯·æä¾›æ–‡ä»¶URL")
        sys.exit(1)
    
    if not cookie:
        print("âŒ é”™è¯¯: è¯·è®¾ç½®WENSHUSHU_COOKIEç¯å¢ƒå˜é‡")
        sys.exit(1)
    
    # åˆ›å»ºä¸Šä¼ å™¨å®ä¾‹
    uploader = WenshushuUploader(cookie)
    
    # æ£€æŸ¥ç™»å½•çŠ¶æ€
    if not uploader.check_login():
        print("âŒ ç™»å½•çŠ¶æ€æ— æ•ˆï¼Œè¯·æ£€æŸ¥cookie")
        sys.exit(1)
    
    # ä¸´æ—¶æ–‡ä»¶è·¯å¾„
    temp_dir = '/tmp/wenshushu_upload'
    os.makedirs(temp_dir, exist_ok=True)
    temp_file = os.path.join(temp_dir, f'temp_{int(time.time())}')
    
    try:
        # ä¸‹è½½æ–‡ä»¶
        original_name, file_size = uploader.download_file(file_url, temp_file)
        if not original_name:
            sys.exit(1)
        
        # ä½¿ç”¨è‡ªå®šä¹‰åç§°æˆ–åŸå§‹åç§°
        filename = custom_name if custom_name else original_name
        
        # ä¸Šä¼ æ–‡ä»¶
        result = uploader.upload_file(temp_file, filename, days)
        if result:
            # è¾“å‡ºç»“æœä¾›GitHub Actionsä½¿ç”¨
            print(f"::set-output name=download_url::{result['download_url']}")
            print(f"::set-output name=file_code::{result['file_code']}")
            print(f"::set-output name=file_name::{result['file_name']}")
            print(f"::set-output name=expire_days::{result['expire_days']}")
            
            # ä¿å­˜ç»“æœåˆ°æ–‡ä»¶
            with open('upload_result.json', 'w') as f:
                json.dump(result, f, ensure_ascii=False, indent=2)
        else:
            sys.exit(1)
            
    finally:
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if os.path.exists(temp_file):
            os.remove(temp_file)
    
    print("ğŸ‰ æ–‡ä»¶ä¸Šä¼ æµç¨‹å®Œæˆ")

if __name__ == '__main__':
    main()
EOF
        
    - name: Run upload script
      id: upload
      env:
        WENSHUSHU_COOKIE: ${{ secrets.WENSHUSHU_COOKIE }}
        INPUT_FILE_URL: ${{ github.event.inputs.file_url }}
        INPUT_CUSTOM_NAME: ${{ github.event.inputs.custom_name }}
        INPUT_DAYS: ${{ github.event.inputs.days }}
      run: |
        python upload_script.py
        
    - name: Show result
      run: |
        echo "âœ… ä¸Šä¼ æˆåŠŸï¼"
        echo "ğŸ“ æ–‡ä»¶åç§°: ${{ steps.upload.outputs.file_name }}"
        echo "ğŸ”— ä¸‹è½½é“¾æ¥: ${{ steps.upload.outputs.download_url }}"
        echo "ğŸ“… æœ‰æ•ˆæœŸ: ${{ steps.upload.outputs.expire_days }}å¤©"
        
    - name: Upload result artifact
      uses: actions/upload-artifact@v3
      with:
        name: upload-result
        path: upload_result.json
        
    - name: Create summary
      run: |
        echo "## ğŸ“¤ æ–‡å”å”æ–‡ä»¶ä¸Šä¼ ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **çŠ¶æ€**: ä¸Šä¼ æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ **æ–‡ä»¶**: ${{ steps.upload.outputs.file_name }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **é“¾æ¥**: [${{ steps.upload.outputs.download_url }}](${{ steps.upload.outputs.download_url }})" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… **æœ‰æ•ˆæœŸ**: ${{ steps.upload.outputs.expire_days }}å¤©" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° **ä¸Šä¼ æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
